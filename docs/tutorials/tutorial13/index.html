<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">Active Shape Model Fitting | Scalismo</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="0.90"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-0.90"><meta data-react-helmet="true" property="og:title" content="Active Shape Model Fitting | Scalismo"><meta data-react-helmet="true" name="description" content="In this tutorial we show how we can perform active shape model fitting in Scalismo."><meta data-react-helmet="true" property="og:description" content="In this tutorial we show how we can perform active shape model fitting in Scalismo."><meta data-react-helmet="true" property="og:url" content="https://scalismo.org/docs/tutorials/tutorial13"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://scalismo.org/docs/tutorials/tutorial13"><link rel="stylesheet" href="/styles.656a0876.css">
<link rel="preload" href="/styles.0daa2ecb.js" as="script">
<link rel="preload" href="/runtime~main.79bb97c1.js" as="script">
<link rel="preload" href="/main.0069e762.js" as="script">
<link rel="preload" href="/1.d0a04477.js" as="script">
<link rel="preload" href="/88.19909525.js" as="script">
<link rel="preload" href="/90.32728c13.js" as="script">
<link rel="preload" href="/f68ef350.5162599f.js" as="script">
<link rel="preload" href="/87.bdda081e.js" as="script">
<link rel="preload" href="/529de9b8.fb395741.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Scalismo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Scalismo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Scalismo</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/onlinecourse">Online courses</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/support">Support</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/">0.90</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/tutorials/tutorial13">Next</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/tutorials/tutorial13">0.90</a></li><li><a class="dropdown__link" href="/docs/0.18/tutorials/tutorial13">0.18</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Scalismo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Scalismo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Scalismo</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/onlinecourse">Online courses</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/support">Support</a></li><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/tutorials/tutorial13">Next</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/tutorials/tutorial13">0.90</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/0.18/tutorials/tutorial13">0.18</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial1">Hello Scalismo!</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial2">Rigid Alignment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial3">From meshes to deformation fields</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial4">Gaussian processes and Point Distribution Models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial5">Gaussian processes, sampling and marginalization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial6">Building a shape model from data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial7">Shape modelling with Gaussian processes and kernels</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial8">Posterior shape models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial9">Shape completion using GP regression</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial10">Iterative Closest Points for rigid alignment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial11">Model fitting with Iterative Closest Points</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial12">Parametric, non-rigid registration</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/tutorials/tutorial13">Active Shape Model Fitting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial14">Model fitting using MCMC - The basic framework</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/tutorials/tutorial15">Model fitting using MCMC - Fitting a shape model</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Others</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/tutorials/scalismo-ui-introduction">Introduction to Scalismo-ui</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><div><span class="badge badge--secondary">Version: 0.90</span></div><header><h1 class="docTitle_1Lrw">Active Shape Model Fitting</h1></header><div class="markdown"><p>In this tutorial we show how we can perform active shape model fitting in Scalismo.</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="related-resources"></a>Related resources<a aria-hidden="true" class="hash-link" href="#related-resources" title="Direct link to heading">#</a></h5><p>The following resources from our <a href="https://www.futurelearn.com/courses/statistical-shape-modelling" target="_blank" rel="noopener noreferrer">online course</a> may provide
some helpful context for this tutorial:</p><ul><li>Fitting models to images <a href="https://www.futurelearn.com/courses/statistical-shape-modelling/3/steps/250379" target="_blank" rel="noopener noreferrer">(Video)</a></li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="preparation"></a>Preparation<a aria-hidden="true" class="hash-link" href="#preparation" title="Direct link to heading">#</a></h5><p>As in the previous tutorials, we start by importing some commonly used objects and initializing the system.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.geometry._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.transformations._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.registration._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.mesh.TriangleMesh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.statisticalmodel.asm._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.io.{ActiveShapeModelIO, ImageIO}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.ui.api._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import breeze.linalg.{DenseVector}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">scalismo.initialize()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">implicit val rng = scalismo.utils.Random(42)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val ui = ScalismoUI()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="active-shape-models-in-scalismo"></a>Active Shape models in Scalismo<a aria-hidden="true" class="hash-link" href="#active-shape-models-in-scalismo" title="Direct link to heading">#</a></h2><p>Scalismo provides full support for Active Shape models. This means we can use it to learn active shape models from
a set of images and corresponding contour, we can save these models, and we can use them to fit images. In this tutorial
we will assume that the model has already been built and will only concentrate on model fitting.</p><p>We can load an Active Shape Model as follows:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val asm = ActiveShapeModelIO.readActiveShapeModel(new java.io.File(&quot;datasets/femur-asm.h5&quot;)).get</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>An ActiveShapeModel instance in Scalismo is a combination of a statistical shape model and an intensity model.
Using the method <code>statisticalModel</code>, we can obtain the shape model part. Let&#x27;s visualize this model:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val modelGroup = ui.createGroup(&quot;modelGroup&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val modelView = ui.show(modelGroup, asm.statisticalModel, &quot;shapeModel&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The second part of the model is the intensity model. This model consists of a set of profiles,
which are attached to specific vertices of the shape model, indicated by the <code>pointId</code>.
For each profile, a probability distribution is defined. This distribution represent the intensity variation that we
expect for this profile.</p><p>The following code shows how this information can be accessed:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val profiles = asm.profiles</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">profiles.map(profile =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  val pointId = profile.pointId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  val distribution = profile.distribution</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="finding-likely-model-correspondences-in-an-image"></a>Finding likely model correspondences in an image<a aria-hidden="true" class="hash-link" href="#finding-likely-model-correspondences-in-an-image" title="Direct link to heading">#</a></h4><p>The main usage of the profile distribution is to identify the points in the image, which are most likely to correspond to the given profile points in the model.
More precisely, let <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> denote the i-th profile in the model. We can use the information to evaluate for any set of points
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x_1, \ldots, x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>, how likely it is that a point <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">x_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.716668em;vertical-align:-0.286108em"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.311664em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em"><span></span></span></span></span></span></span></span></span></span></span> corresponds to the profile point <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em"></span><span class="mord"><span class="mord mathdefault">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>, based on the image intensity patterns
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ρ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mn>1</mn></msub><mo stretchy="false">)</mo><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>ρ</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\rho(x_1), \ldots, \rho(x_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathdefault">ρ</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.30110799999999993em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em"></span><span class="mord mathdefault">ρ</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> we find at these points in an image.</p><p>To illustrate this, we first load an image:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val image = ImageIO.read3DScalarImage[Short](new java.io.File(&quot;datasets/femur-image.nii&quot;)).get.map(_.toFloat)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val targetGroup = ui.createGroup(&quot;target&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val imageView = ui.show(targetGroup, image, &quot;image&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The ASM implementation in Scalismo, is not restricted to work with the raw intensities, but the active shape model may first apply some preprocessing,
such as smooth, applying a gradient transform, etc.  Thus in a first step we obtain this preprocess iamge uing the prepocessor method of the <code>asm</code> object:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val preprocessedImage = asm.preprocessor(image)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We can now extract features at a given point:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val point1 = image.domain.origin + EuclideanVector3D(10.0, 10.0, 10.0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val profile = asm.profiles.head</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val feature1 : DenseVector[Double] = asm.featureExtractor(preprocessedImage, point1, asm.statisticalModel.mean, profile.pointId).get</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Here we specified the preprocessed image, a point in the image where whe want the evaluate the feature vector, a mesh instance and a point id for the mesh.
The mesh instance and point id are needed, since a feature extractor might choose to extract the feature based on mesh information, such as the normal direction
of a line at this point.</p><p>We can retrieve the likelihood that each corresponding point corresponds to a given profile point:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val point2 = image.domain.origin + EuclideanVector3D(20.0, 10.0, 10.0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val featureVec1 = asm.featureExtractor(preprocessedImage, point1, asm.statisticalModel.mean, profile.pointId).get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val featureVec2 = asm.featureExtractor(preprocessedImage, point2, asm.statisticalModel.mean, profile.pointId).get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val probabilityPoint1 = profile.distribution.logpdf(featureVec1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val probabilityPoint2 = profile.distribution.logpdf(featureVec2)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Based on this information, we can decide, which point is more likely to correspond to the model point. This idea forms the
basis of the original m Active Shape Model Fitting algorithm.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-original-active-shape-model-fitting"></a>The original Active Shape Model Fitting<a aria-hidden="true" class="hash-link" href="#the-original-active-shape-model-fitting" title="Direct link to heading">#</a></h3><p>Scalismo features an implementation of Active Shape Model fitting algorithm, as proposed by <a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.141.3089&amp;rep=rep1&amp;type=pdf" target="_blank" rel="noopener noreferrer">Cootes and Taylor</a>.</p><p>To configure the fitting process, we need to set up a search method, which searches for a given model point, corresponding  points
in the image. From these points, the most likely point is select and used as as the corresponding point for one iteration of
the algorithm. Once these &quot;candidate correspondences&quot; have been established, the rest of the algorithm works in exactly the same as
the ICP algorithm that we described in the previous tutorials.</p><p>One search strategy that is already implemented in Scalismo is to search along
the normal direction of a model point. This behavior is provided by the <code>NormalDirectionSearchPointSampler</code></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val searchSampler = NormalDirectionSearchPointSampler(numberOfPoints = 100, searchDistance = 3)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>In addition to the search strategy, we can specify some additional configuration parameters to control the fitting process:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val config = FittingConfiguration(featureDistanceThreshold = 3, pointDistanceThreshold = 5, modelCoefficientBounds = 3)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>The first parameter determines how far away (as measured by the mahalanobis distance) an intensity feature can be, such that it is still
chosen as corresponding. The <code>pointDistanceThreshold</code> does the same for the distance of the points; I.e. in this  case points which are
more than 5 standard deviations aways are not chosen as corresponding points. The last parameters determines how
large coefficients of the model can become in the fitting process. Whenever a model parameter is larger than this threshold,
it will be set back to this maximal value. This introduces a regularization into the fitting, which prevents the shape
from becoming too unlikely.</p><p>The ASM fitting algorithm optimizes both the pose (as defined by a rigid transformation) and the shape.
In order to allow it to optimize the rotation, it is important that we choose a rotation center, which is approximately
the center of mass of the model:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">    // make sure we rotate around a reasonable center point</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val modelBoundingBox = asm.statisticalModel.referenceMesh.boundingBox</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val rotationCenter = modelBoundingBox.origin + modelBoundingBox.extent * 0.5</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>To initialize the fitting process, we also need to set up the initial transformation:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// we start with the identity transform</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val translationTransformation = Translation3D(EuclideanVector3D(0, 0, 0))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val rotationTransformation = Rotation3D(0, 0, 0, rotationCenter)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val initialRigidTransformation = TranslationAfterRotation3D(translationTransformation, rotationTransformation)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val initialModelCoefficients = DenseVector.zeros[Double](asm.statisticalModel.rank)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val initialTransformation = ModelTransformations(initialModelCoefficients, initialRigidTransformation)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>To start the fitting, we obtain an iterator, which we subsequently use to drive the iteration.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val numberOfIterations = 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val asmIterator = asm.fitIterator(image, searchSampler, numberOfIterations, config, initialTransformation)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Especially in a debugging phase, we want to visualize the result in every iteration. The following code shows,
how we can obtain a new iterator, which updates the pose transformation and model coefficients in the <code>ui</code>
in every iteration:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val asmIteratorWithVisualization = asmIterator.map(it =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    it match {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case scala.util.Success(iterationResult) =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            modelView.shapeModelTransformationView.poseTransformationView.transformation = iterationResult.transformations.rigidTransform</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            modelView.shapeModelTransformationView.shapeTransformationView.coefficients = iterationResult.transformations.coefficients</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        case scala.util.Failure(error) =&gt; System.out.println(error.getMessage)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>To run the fitting, and get the result, we finally consume the iterator:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val result = asmIteratorWithVisualization.toIndexedSeq.last</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val finalMesh = result.get.mesh</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="evaluating-the-likelihood-of-a-model-instance-under-the-image"></a>Evaluating the likelihood of a model instance under the image<a aria-hidden="true" class="hash-link" href="#evaluating-the-likelihood-of-a-model-instance-under-the-image" title="Direct link to heading">#</a></h2><p>In the previous section we have used the intensity distribution to find the best corresponding image point to a
given point in the model. Sometimes we are also interested in finding out how well a model fits an image.
To compute this, we can extend the method used above to compute the likelihood for all profile points of an Active Shape Model.</p><p>Given the model instance, we will get the position of each profile point in the current instance,
evaluate its likelihood and then compute the joint likelihood for all profiles. Assuming independence, the joint probability is just the product of the probability at the individual profile points.
In order not to get too extreme values, we use log probabilities here (and consequently the product becomes a sum).</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">def likelihoodForMesh(asm : ActiveShapeModel, mesh : TriangleMesh[_3D], preprocessedImage: PreprocessedImage) : Double = {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    val ids = asm.profiles.ids</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    val likelihoods = for (id &lt;- ids) yield {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      val profile = asm.profiles(id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      val profilePointOnMesh = mesh.pointSet.point(profile.pointId)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      val featureAtPoint = asm.featureExtractor(preprocessedImage, profilePointOnMesh, mesh, profile.pointId).get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      profile.distribution.logpdf(featureAtPoint)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    likelihoods.sum</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>This method allows us to compute for each mesh, represented by the model, how likely it is to correspond
to the given image.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val sampleMesh1 = asm.statisticalModel.sample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val sampleMesh2 = asm.statisticalModel.sample</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">println(&quot;Likelihood for mesh 1 = &quot; + likelihoodForMesh(asm, sampleMesh1, preprocessedImage))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">println(&quot;Likelihood for mesh 2 = &quot; + likelihoodForMesh(asm, sampleMesh2, preprocessedImage))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>This information is all that is need to write probabilistic fitting methods methods using Markov Chain Monte Carlo
methods, which will be discussed in a later tutorial.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/unibas-gravis/scalismo-microsite/edit/master/website/versioned_docs/version-0.90/tutorials/tutorial13.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/tutorials/tutorial12"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Parametric, non-rigid registration</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/tutorials/tutorial14"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Model fitting using MCMC - The basic framework »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#active-shape-models-in-scalismo" class="table-of-contents__link">Active Shape models in Scalismo</a><ul><li><a href="#the-original-active-shape-model-fitting" class="table-of-contents__link">The original Active Shape Model Fitting</a></li></ul></li><li><a href="#evaluating-the-likelihood-of-a-model-instance-under-the-image" class="table-of-contents__link">Evaluating the likelihood of a model instance under the image</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Tutorial</a></li><li class="footer__item"><a href="http://unibas-gravis.github.io/scalismo/latest/api/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">API-Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://groups.google.com/g/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://gitter.im/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter-Chat</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2021 University of Basel. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.0daa2ecb.js"></script>
<script src="/runtime~main.79bb97c1.js"></script>
<script src="/main.0069e762.js"></script>
<script src="/1.d0a04477.js"></script>
<script src="/88.19909525.js"></script>
<script src="/90.32728c13.js"></script>
<script src="/f68ef350.5162599f.js"></script>
<script src="/87.bdda081e.js"></script>
<script src="/529de9b8.fb395741.js"></script>
</body>
</html>