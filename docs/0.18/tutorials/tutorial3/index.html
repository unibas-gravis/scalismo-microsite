<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.68">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous"><title data-react-helmet="true">From meshes to deformation fields | Scalismo</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" name="docusaurus_language" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="0.18"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-0.18"><meta data-react-helmet="true" property="og:title" content="From meshes to deformation fields | Scalismo"><meta data-react-helmet="true" name="description" content="In this tutorial, we show how the deformation fields that relate two meshes can be computed and visualized."><meta data-react-helmet="true" property="og:description" content="In this tutorial, we show how the deformation fields that relate two meshes can be computed and visualized."><meta data-react-helmet="true" property="og:url" content="https://scalismo.org/docs/0.18/tutorials/tutorial3"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://scalismo.org/docs/0.18/tutorials/tutorial3"><link rel="stylesheet" href="/styles.656a0876.css">
<link rel="preload" href="/styles.0daa2ecb.js" as="script">
<link rel="preload" href="/runtime~main.79bb97c1.js" as="script">
<link rel="preload" href="/main.0069e762.js" as="script">
<link rel="preload" href="/1.d0a04477.js" as="script">
<link rel="preload" href="/88.19909525.js" as="script">
<link rel="preload" href="/90.32728c13.js" as="script">
<link rel="preload" href="/7ca117c4.beb00885.js" as="script">
<link rel="preload" href="/87.bdda081e.js" as="script">
<link rel="preload" href="/78629013.7135d72b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav aria-label="Skip navigation links"><button type="button" tabindex="0" class="skipToContent_2AhQ">Skip to main content</button></nav><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Scalismo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Scalismo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Scalismo</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/onlinecourse">Online courses</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/support">Support</a><a class="navbar__item navbar__link" href="/about">About</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/docs/0.18/">0.18</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/next/tutorials/tutorial3">Next</a></li><li><a class="dropdown__link" href="/docs/tutorials/tutorial3">0.90</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/0.18/tutorials/tutorial3">0.18</a></li></ul></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="Scalismo" class="themedImage_2E_h themedImage--light_AouX navbar__logo"><img alt="Scalismo" class="themedImage_2E_h themedImage--dark_1YPN navbar__logo"><strong class="navbar__title">Scalismo</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/onlinecourse">Online courses</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a class="menu__link" href="/support">Support</a></li><li class="menu__list-item"><a class="menu__link" href="/about">About</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/next/tutorials/tutorial3">Next</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/tutorials/tutorial3">0.90</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/docs/0.18/tutorials/tutorial3">0.18</a></li></ul></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive thin-scrollbar menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Tutorials</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial1">Hello Scalismo!</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial2">Rigid Alignment</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/0.18/tutorials/tutorial3">From meshes to deformation fields</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial4">Gaussian processes and Point Distribution Models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial5">Gaussian processes, sampling and marginalization</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial6">Building a shape model from data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial7">Shape modelling with Gaussian processes and kernels</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial8">Posterior Shape Models</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial9">Shape completion using Gaussian process regression</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial10">Iterative Closest Points for rigid alignment</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial11">Model fitting with Iterative Closest Points</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial12">Parametric, non-rigid registration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial13">Active Shape Model fitting</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial14">Model fitting using MCMC - The basic framework</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.18/tutorials/tutorial15">Model fitting using MCMC - Fitting a shape model</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Others</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/0.18/tutorials/scalismo-ui-introduction">Introduction to Scalismo-ui</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_39qw"><div class="row"><div class="col docItemCol_2ASc"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for Scalismo <strong>0.18</strong>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/docs/tutorials/tutorial3">latest version</a></strong> (0.90).</div></div><div class="docItemContainer_3QWW"><article><div><span class="badge badge--secondary">Version: 0.18</span></div><header><h1 class="docTitle_1Lrw">From meshes to deformation fields</h1></header><div class="markdown"><p><em>In this tutorial, we show how the deformation fields that relate two meshes can be computed and visualized.</em></p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="related-resources"></a>Related resources<a aria-hidden="true" class="hash-link" href="#related-resources" title="Direct link to heading">#</a></h5><p>The following resources from our <a href="https://www.futurelearn.com/courses/statistical-shape-modelling" target="_blank" rel="noopener noreferrer">online course</a> may provide
some helpful context for this tutorial:</p><ul><li>Modelling Shape Deformations <a href="https://www.futurelearn.com/courses/statistical-shape-modelling/3/steps/250326" target="_blank" rel="noopener noreferrer">(Video)</a></li></ul><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="preparation"></a>Preparation<a aria-hidden="true" class="hash-link" href="#preparation" title="Direct link to heading">#</a></h5><p>As in the previous tutorials, we start by importing some commonly used objects and initializing the system.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.geometry._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.common._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.ui.api._</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.registration.Transformation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">scalismo.initialize()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">implicit val rng = scalismo.utils.Random(42)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val ui = ScalismoUI()</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We will also load three meshes and visualize them in Scalismo-ui.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">import scalismo.io.MeshIO</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val dsGroup = ui.createGroup(&quot;datasets&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val meshFiles = new java.io.File(&quot;datasets/testFaces/&quot;).listFiles.take(3)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val (meshes, meshViews) = meshFiles.map(meshFile =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  val mesh = MeshIO.readMesh(meshFile).get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  val meshView = ui.show(dsGroup, mesh, &quot;mesh&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  (mesh, meshView) // return a tuple of the mesh and the associated view</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}) .unzip // take the tuples apart, to get a sequence of meshes and one of meshViews</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="representing-meshes-as-deformations"></a>Representing meshes as deformations<a aria-hidden="true" class="hash-link" href="#representing-meshes-as-deformations" title="Direct link to heading">#</a></h3><p>In the following we show how we can represent a mesh as a reference mesh plus a deformation field. This is possible
because the meshes are all in correspondence; I.e. they all have the same number of points and points with the same id in the meshes represent
the same point/region in the mesh.</p><p>Let&#x27;s say <em>face_0</em>, is the reference mesh:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val reference = meshes(0) // face_0 is our reference</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Now any mesh, which is in correspondence with this reference, can be represented as a deformation field.
The deformation field is defined on this reference mesh; I.e. the points of
the reference mesh are the domain on which the deformation field is defined.</p><p>The deformations can be computed by taking the difference between the corresponding
point of the mesh and the reference:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val deformations : IndexedSeq[EuclideanVector[_3D]] = reference.pointSet.pointIds.map {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id =&gt;  meshes(1).pointSet.point(id) - reference.pointSet.point(id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}.toIndexedSeq</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>From these deformations, we can then create a <code>DiscreteVectorField</code>:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val deformationField = DiscreteField[_3D, UnstructuredPointsDomain[_3D], EuclideanVector[_3D]](reference.pointSet, deformations)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Similar to discrete scalar images, a Discrete Vector Field is defined
over a discrete domain. In contrast to images, the domain does not need to be
structured (a grid for example) and can be any arbitrary finite set of points. In the above example code, we defined the domain to be the reference mesh points, which
is of type <code>UnstructuredPointsDomain[_3D]</code>, as we can easily check:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val refDomain : UnstructuredPointsDomain[_3D] = reference.pointSet</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// refDomain: UnstructuredPointsDomain[_3D] = scalismo.common.UnstructuredPointsDomain3D@e36f4d21</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">deformationField.domain == refDomain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// res1: Boolean = true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>As for images, the deformation vector associated with a particular point id in a <em>DiscreteVectorField</em> can be retrieved via its point id:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">deformationField(PointId(0))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// res2: EuclideanVector[_3D] = EuclideanVector3D(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   -0.031402587890625,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   -0.24579620361328125,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   4.780601501464844</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We can visualize this deformation field in Scalismo-ui using the usual <code>show</code>
command:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val deformationFieldView = ui.show(dsGroup, deformationField, &quot;deformations&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We can see that the deformation vectors indeed point from the reference to <em>face_1</em>.
To see the effect better we need to remove <em>face2</em> from the ui,
make the reference transparent</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">meshViews(2).remove()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">meshViews(0).opacity = 0.3</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p><em>Exercise: generate the rest of the deformation fields that represent the rest of the faces in the dataset and display them.</em></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="deformation-fields-over-continuous-domains"></a>Deformation fields over continuous domains:<a aria-hidden="true" class="hash-link" href="#deformation-fields-over-continuous-domains" title="Direct link to heading">#</a></h3><p>The deformation field that we computed above is discrete as it is
defined only over the mesh points. Since the real-world objects that we
model are continuous, and the discretization of our meshes is rather
arbitrary, this is not ideal. In Scalismo we usually prefer to work with
continuous domains.
Whenever we have an object in Scalismo, which is defined on a discrete domain,
we can obtain a continuous representation, by means
of interpolation.</p><p>To turn our deformation field into a continuous deformation field, we need to define an <code>Interpolator</code> and call the <code>interpolate</code>
method:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val interpolator = NearestNeighborInterpolator[_3D, EuclideanVector[_3D]]()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val continuousDeformationField : Field[_3D, EuclideanVector[_3D]] = deformationField.interpolate(interpolator)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>As we do not know much about the structure of the points that define the mesh,
we use a <code>NearestNeighborInterpolator</code>, which means that for every point on
which we want to evaluate the deformation, the nearest point on the mesh is
found and returned.</p><p>The resulting  deformation field is now defined over the entire real space and
can be evaluated at any 3D Point:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">continuousDeformationField(Point(-100,-100,-100))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// res5: EuclideanVector[_3D] = EuclideanVector3D(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   7.967502593994141,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   1.7736968994140625,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   -6.764269828796387</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// )</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p><em>Remark: This approach is general: Any discrete object in Scalismo can be interpolated.
For more structured domains, such as the <code>DiscreteImageDomain</code>, we can use
more sophisticated interpolation schemes, such as linear or b-spline interpolation.</em></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-mean-deformation-and-the-mean-mesh"></a>The mean deformation and the mean mesh<a aria-hidden="true" class="hash-link" href="#the-mean-deformation-and-the-mean-mesh" title="Direct link to heading">#</a></h3><p>Given a set of meshes, we are often interested to compute mesh that represents the mean shape.
This is equivalent to computing the mean deformation <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>u</mi><mo stretchy="true">‾</mo></mover></mrow><annotation encoding="application/x-tex">\overline{u}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.63056em;vertical-align:0em"></span><span class="mord overline"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.63056em"><span style="top:-3em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathdefault">u</span></span></span><span style="top:-3.55056em"><span class="pstrut" style="height:3em"></span><span class="overline-line" style="border-bottom-width:0.04em"></span></span></span></span></span></span></span></span></span></span>, and to apply this deformation to them mean mesh.</p><p>To compute the mean deformation, we compute for each point in our mesh the sample mean of the
deformations at this point in the deformation fields:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val nMeshes = meshes.length</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val meanDeformations = reference.pointSet.pointIds.map( id =&gt; {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  var meanDeformationForId = EuclideanVector(0, 0, 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  val meanDeformations = meshes.foreach (mesh =&gt; { // loop through meshes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    val deformationAtId = mesh.pointSet.point(id) - reference.pointSet.point(id)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    meanDeformationForId += deformationAtId * (1.0 / nMeshes)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  })</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  meanDeformationForId</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">})</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val meanDeformationField = DiscreteField[_3D, UnstructuredPointsDomain[_3D], EuclideanVector[_3D]](</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  reference.pointSet,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  meanDeformations.toIndexedSeq</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>We can now apply the deformation to every point of the reference mesh, to obtain the mean mesh.
To do this, the easiest way is to first genenerate a transformation from the deformation field, which
we can use to map every point of the reference to its mean:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val continuousMeanDeformationField = meanDeformationField.interpolate(interpolator)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">val meanTransformation = Transformation((pt : Point[_3D]) =&gt; pt + continuousMeanDeformationField(pt))</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>To obtain the mean mesh, we simply apply this transformation to the reference mesh:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">val meanMesh = reference.transform(meanTransformation)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div><p>Finally, we display the result:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><div tabindex="0" class="prism-code language-scala codeBlock_3iAC thin-scrollbar"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">ui.show(dsGroup, meanMesh, &quot;mean mesh&quot;)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button></div></div></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/unibas-gravis/scalismo-microsite/edit/master/website/versioned_docs/version-0.18/tutorials/tutorial3.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/0.18/tutorials/tutorial2"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Rigid Alignment</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/0.18/tutorials/tutorial4"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Gaussian processes and Point Distribution Models »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_ thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#representing-meshes-as-deformations" class="table-of-contents__link">Representing meshes as deformations</a></li><li><a href="#deformation-fields-over-continuous-domains" class="table-of-contents__link">Deformation fields over continuous domains:</a></li><li><a href="#the-mean-deformation-and-the-mean-mesh" class="table-of-contents__link">The mean deformation and the mean mesh</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Tutorial</a></li><li class="footer__item"><a href="http://unibas-gravis.github.io/scalismo/latest/api/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">API-Doc</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://groups.google.com/g/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Forum</a></li><li class="footer__item"><a href="https://gitter.im/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">Gitter-Chat</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/unibas-gravis/scalismo" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright © 2021 University of Basel. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.0daa2ecb.js"></script>
<script src="/runtime~main.79bb97c1.js"></script>
<script src="/main.0069e762.js"></script>
<script src="/1.d0a04477.js"></script>
<script src="/88.19909525.js"></script>
<script src="/90.32728c13.js"></script>
<script src="/7ca117c4.beb00885.js"></script>
<script src="/87.bdda081e.js"></script>
<script src="/78629013.7135d72b.js"></script>
</body>
</html>